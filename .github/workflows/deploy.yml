name: ğŸš€ éƒ¨ç½² Note API

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ æ·»åŠ æœåŠ¡å™¨æŒ‡çº¹
        run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ ä¸Šä¼ ä»£ç 
        run: |
          rsync -avz --delete \
            --exclude '.git' --exclude 'target' --exclude '.env' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/note/

      - name: ğŸ“ ç”Ÿæˆé…ç½®æ–‡ä»¶
        run: |
          # ç”Ÿæˆ .env æ–‡ä»¶
          cat > .env << EOF
          APP_HOST=0.0.0.0
          APP_PORT=8000
          DATABASE_URL=mysql://easynote:${{ secrets.MYSQL_USER_PASSWORD }}@db/note
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          RUST_LOG=info
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER_PASSWORD=${{ secrets.MYSQL_USER_PASSWORD }}
          EOF

          # ç”Ÿæˆ docker-compose.prod.yml æ–‡ä»¶
          cat > docker-compose.prod.yml << EOF
          version: '3.8'
          services:
            db:
              image: mysql:8.0
              environment:
                MYSQL_DATABASE: note
                MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
                MYSQL_USER: easynote
                MYSQL_PASSWORD: ${{ secrets.MYSQL_USER_PASSWORD }}
              volumes:
                - mysql_data:/var/lib/mysql
              networks:
                - note-network
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
                interval: 10s
                timeout: 5s
                retries: 5

            api:
              build: .
              ports:
                - "8000:8000"
              environment:
                DATABASE_URL: mysql://easynote:${{ secrets.MYSQL_USER_PASSWORD }}@db/note
                APP_HOST: 0.0.0.0
                APP_PORT: 8000
                JWT_SECRET: ${{ secrets.JWT_SECRET }}
                RUST_LOG: info
              depends_on:
                db:
                  condition: service_healthy
              networks:
                - note-network
              restart: unless-stopped

          volumes:
            mysql_data:

          networks:
            note-network:
          EOF

      - name: ğŸ“¤ ä¸Šä¼ é…ç½®æ–‡ä»¶
        run: |
          scp .env ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/note/.env
          scp docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/opt/note/docker-compose.yml

      - name: ğŸš€ éƒ¨ç½²
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_USER_PASSWORD: ${{ secrets.MYSQL_USER_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          cat > /tmp/.env << EOF
          APP_HOST=0.0.0.0
          APP_PORT=8000
          DATABASE_URL=mysql://note_user:${MYSQL_USER_PASSWORD}@db/note_db
          JWT_SECRET=${JWT_SECRET}
          RUST_LOG=info
          MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
          MYSQL_USER_PASSWORD=${MYSQL_USER_PASSWORD}
          EOF

          scp /tmp/.env ${SERVER_USER}@${SERVER_IP}:/opt/note/.env

          ssh ${SERVER_USER}@${SERVER_IP} 'cd /opt/note && nohup sudo docker compose up -d --build > /tmp/deploy.log 2>&1 &' || true

          echo "ğŸš€ éƒ¨ç½²å·²åœ¨åå°å¯åŠ¨ï¼Œå¯ä»¥ SSH åˆ°æœåŠ¡å™¨æŸ¥çœ‹è¿›åº¦ï¼š"
          echo "   tail -f /tmp/deploy.log"

      - name: ğŸ§ª å¥åº·æ£€æŸ¥
        run: |
          sleep 10
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "curl -f http://localhost:8000/health" && echo "âœ… æˆåŠŸ" || echo "âš ï¸ å¤±è´¥"
